---
- name: Install general certs
  apt: name={{ item }} state=present
  with_items:
    - curl
    - ca-certificates
    - apt-transport-https

- name: Create a ca-certs directory
  become: true
  file: path=/usr/local/share/ca-certificates/cacert.org state=directory

- name: Download CA Certs root certificate
  become: true
  get_url: url=http://www.cacert.org/certs/root.crt dest=/usr/local/share/ca-certificates/cacert.org/root.crt

- name: Download CA Certs class 3 certificate
  become: true
  get_url: url=http://www.cacert.org/certs/class3.crt dest=/usr/local/share/ca-certificates/cacert.org/class3.crt

- name: Update certificates
  become: true
  shell: /usr/sbin/update-ca-certificates -f

- name: Add the docker group
  group: name=docker gid=998 state=present

# Using apt-key within the ansible python code breaks on Ubuntu 14.04 due to openssl package dependencies breaking
- name: Add Docker GPG key
  command: bash -lc "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -"

- name: Add Docker APT repository
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ansible_distribution_release}} stable
  when: ansible_architecture == "x86_64"

- name: Install Docker CE and it dependencies
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
    - software-properties-common
    - docker-ce
  when: ansible_architecture == "x86_64"

#- name: Install the microk8s Kubernetes distribution
#  snap:
#    name: microk8s
#    classic: yes
#    channel: "1.12/stable"

- name: Start Docker
  service: name=docker state=restarted
  when: ansible_architecture == "x86_64"

